package main

// Test: Null coalescing integration with safe navigation
// Feature: ?? operator combined with ?.
// Complexity: intermediate

type UserOption_Tag int

const (
	UserOption_Tag_Some UserOption_Tag = iota
	UserOption_Tag_None
)

type UserOption struct {
	tag  UserOption_Tag
	some *User
}

func UserOption_Some(value User) UserOption {
	return UserOption{tag: UserOption_Tag_Some, some: &value}
}

func UserOption_None() UserOption {
	return UserOption{tag: UserOption_Tag_None, some: nil}
}

func (o UserOption) IsSome() bool {
	return o.tag == UserOption_Tag_Some
}

func (o UserOption) IsNone() bool {
	return o.tag == UserOption_Tag_None
}

func (o UserOption) Unwrap() User {
	if o.IsNone() {
		panic("called Unwrap on None")
	}
	return *o.some
}

type AddressOption_Tag int

const (
	AddressOption_Tag_Some AddressOption_Tag = iota
	AddressOption_Tag_None
)

type AddressOption struct {
	tag  AddressOption_Tag
	some *Address
}

func AddressOption_Some(value Address) AddressOption {
	return AddressOption{tag: AddressOption_Tag_Some, some: &value}
}

func AddressOption_None() AddressOption {
	return AddressOption{tag: AddressOption_Tag_None, some: nil}
}

func (o AddressOption) IsSome() bool {
	return o.tag == AddressOption_Tag_Some
}

func (o AddressOption) IsNone() bool {
	return o.tag == AddressOption_Tag_None
}

func (o AddressOption) Unwrap() Address {
	if o.IsNone() {
		panic("called Unwrap on None")
	}
	return *o.some
}

type StringOption_Tag int

const (
	StringOption_Tag_Some StringOption_Tag = iota
	StringOption_Tag_None
)

type StringOption struct {
	tag  StringOption_Tag
	some *string
}

func StringOption_Some(value string) StringOption {
	return StringOption{tag: StringOption_Tag_Some, some: &value}
}

func StringOption_None() StringOption {
	return StringOption{tag: StringOption_Tag_None, some: nil}
}

func (o StringOption) IsSome() bool {
	return o.tag == StringOption_Tag_Some
}

func (o StringOption) IsNone() bool {
	return o.tag == StringOption_Tag_None
}

func (o StringOption) Unwrap() string {
	if o.IsNone() {
		panic("called Unwrap on None")
	}
	return *o.some
}

type User struct {
	name    string
	address AddressOption
}

type Address struct {
	city StringOption
	zip  string
}

func main() {
	// Test 1: user?.name ?? "unknown"
	var user UserOption = getUser(1)
	var userName = func() string {
		__safeNav := func() string {
			if user.IsNone() {
				return ""
			}
			_user := user.Unwrap()
			return _user.name
		}()
		if __safeNav != "" {
			return __safeNav
		}
		return "unknown"
	}()

	// Test 2: user?.address?.city ?? defaultCity
	var defaultCity = "San Francisco"
	var city = func() string {
		__safeNav := func() StringOption {
			if user.IsNone() {
				return StringOption_None()
			}
			_user := user.Unwrap()

			if _user.address.IsNone() {
				return StringOption_None()
			}
			_address := _user.address.Unwrap()

			return _address.city
		}()
		if __safeNav.IsSome() {
			return __safeNav.Unwrap()
		}
		return defaultCity
	}()

	// Test 3: Chain with method calls
	var profile UserOption = fetchProfile()
	var email = func() string {
		__safeNav := func() StringOption {
			if profile.IsNone() {
				return StringOption_None()
			}
			_profile := profile.Unwrap()
			return _profile.getEmail()
		}()
		if __safeNav.IsSome() {
			return __safeNav.Unwrap()
		}
		return "no-email@example.com"
	}()

	// Test 4: Multiple safe nav with different fallbacks
	var user2 UserOption = getUser(2)
	var zip = func() string {
		__safeNav := func() string {
			if user2.IsNone() {
				return ""
			}
			_user := user2.Unwrap()

			if _user.address.IsNone() {
				return ""
			}
			_address := _user.address.Unwrap()

			return _address.zip
		}()
		if __safeNav != "" {
			return __safeNav
		}
		return "00000"
	}()
	var city2 = func() string {
		__safeNav := func() StringOption {
			if user2.IsNone() {
				return StringOption_None()
			}
			_user := user2.Unwrap()

			if _user.address.IsNone() {
				return StringOption_None()
			}
			_address := _user.address.Unwrap()

			return _address.city
		}()
		if __safeNav.IsSome() {
			return __safeNav.Unwrap()
		}
		return "Unknown City"
	}()

	println("User:", userName, "City:", city, "Email:", email)
	println("Zip:", zip, "City2:", city2)
}

func getUser(id int) UserOption {
	if id == 1 {
		addr := AddressOption_Some(Address{
			city: StringOption_Some("New York"),
			zip:  "10001",
		})
		return UserOption_Some(User{name: "Alice", address: addr})
	}
	return UserOption_None()
}

func fetchProfile() UserOption {
	return UserOption_None()
}

func (u User) getEmail() StringOption {
	return StringOption_Some(u.name + "@example.com")
}
