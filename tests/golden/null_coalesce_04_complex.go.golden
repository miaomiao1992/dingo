package main

// Test: Complex null coalescing expressions
// Feature: ?? operator with nested expressions and function calls
// Complexity: advanced

type StringOptionTag uint8

const (
	StringOptionTagSome StringOptionTag = iota
	StringOptionTagNone
)

type StringOption struct {
	tag  StringOptionTag
	some *string
}

func StringOption_Some(arg0 string) StringOption {
	return StringOption{tag: StringOptionTagSome, some: &arg0}
}
func StringOption_None() StringOption {
	return StringOption{tag: StringOptionTagNone}
}
func (e StringOption) IsSome() bool {
	return e.tag == StringOptionTagSome
}
func (e StringOption) IsNone() bool {
	return e.tag == StringOptionTagNone
}

type IntOptionTag uint8

const (
	IntOptionTagSome IntOptionTag = iota
	IntOptionTagNone
)

type IntOption struct {
	tag  IntOptionTag
	some *int
}

func IntOption_Some(arg0 int) IntOption {
	return IntOption{tag: IntOptionTagSome, some: &arg0}
}
func IntOption_None() IntOption {
	return IntOption{tag: IntOptionTagNone}
}
func (e IntOption) IsSome() bool {
	return e.tag == IntOptionTagSome
}
func (e IntOption) IsNone() bool {
	return e.tag == IntOptionTagNone
}

type ConfigOptionTag uint8

const (
	ConfigOptionTagSome ConfigOptionTag = iota
	ConfigOptionTagNone
)

type ConfigOption struct {
	tag  ConfigOptionTag
	some *Config
}

func ConfigOption_Some(arg0 Config) ConfigOption {
	return ConfigOption{tag: ConfigOptionTagSome, some: &arg0}
}
func ConfigOption_None() ConfigOption {
	return ConfigOption{tag: ConfigOptionTagNone}
}
func (e ConfigOption) IsSome() bool {
	return e.tag == ConfigOptionTagSome
}
func (e ConfigOption) IsNone() bool {
	return e.tag == ConfigOptionTagNone
}

type Config struct {
	host string
	port int
}

func main() {
	// Test 1: Function call on right side
	var name StringOption = StringOption_None()
	var display = func() string {
		if name.IsSome() {
			return *name.some
		}
		return getDefaultName()
	}()

	// Test 2: Nested ?? in expressions
	var port IntOption = IntOption_None()
	var finalPort = func() int {
		if port.IsSome() {
			return *port.some
		}
		return 8080
	}() + 1000

	// Test 3: ?? with expressions on both sides
	var config ConfigOption = getConfig()
	var host = func() string {
		__safeNav := func() string {
			if config.IsNone() {
				return ""
			}
			_config := *config.some
			return _config.host
		}()
		if __safeNav != "" {
			return __safeNav
		}
		__env := getEnv("HOST")
		if __env.IsSome() {
			return *__env.some
		}
		return "localhost"
	}()

	// Test 4: Complex chaining with method calls
	var user StringOption = findUser(42)
	var username = func() string {
		__safeNav := func() StringOption {
			if user.IsNone() {
				return StringOption_None()
			}
			_user := *user.some
			return _user.toUpper()
		}()
		if __safeNav.IsSome() {
			return *__safeNav.some
		}
		__guest := getGuestName()
		if __guest.IsSome() {
			return *__guest.some
		}
		return "GUEST"
	}()

	// Test 5: Nested function calls
	var timeout IntOption = IntOption_None()
	var finalTimeout = func() int {
		if timeout.IsSome() {
			return *timeout.some
		}
		__parsed := parseEnv("TIMEOUT")
		if __parsed.IsSome() {
			return *__parsed.some
		}
		return getDefaultTimeout()
	}()

	// Test 6: Mixed with arithmetic
	var count IntOption = IntOption_None()
	var total = func() int {
		if count.IsSome() {
			return *count.some
		}
		return 10
	}() * 2

	println("Display:", display)
	println("Port:", finalPort)
	println("Host:", host)
	println("Username:", username)
	println("Timeout:", finalTimeout)
	println("Total:", total)
}

func getDefaultName() string {
	return "Unknown User"
}

func getEnv(key string) StringOption {
	if key == "HOST" {
		return StringOption_Some("example.com")
	}
	return StringOption_None()
}

func getConfig() ConfigOption {
	return ConfigOption_None()
}

func findUser(id int) StringOption {
	return StringOption_None()
}

func (s StringOption) toUpper() StringOption {
	if s.IsNone() {
		return StringOption_None()
	}
	// Simplified - just return the same for demo
	return s
}

func getGuestName() StringOption {
	return StringOption_None()
}

func parseEnv(key string) IntOption {
	return IntOption_None()
}

func getDefaultTimeout() int {
	return 30
}
