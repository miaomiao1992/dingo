# Phase V: Language Server Foundation - User Request

## Context

**Current Status:**
- Phase 3 complete: Result/Option types, error propagation, sum types, pattern matching
- Phase 4 in progress (separate agent): Lambdas, ternary, null coalescing, tuples
- Running Phase 5 in PARALLEL with Phase 4 (Option 2: Parallel with Staging)

**Coordination:**
- See `/Users/jack/mag/dingo/ai-docs/sessions/phase4-5-coordination.md` for phase coordination
- This session focuses ONLY on LSP support for Phase 3 features
- Phase 4 features will be added in Phase V iteration 2 (after Phase 4 completes)

## Request

Implement a Language Server Protocol (LSP) server for Dingo that provides IDE support.

### Scope for Iteration 1 (This Session)

**Supported Dingo Features (Phase 3 complete):**
1. Type annotations (`: Type` syntax)
2. Error propagation (`?` operator)
3. Result<T, E> types
4. Option<T> types
5. Sum types (enums)
6. Pattern matching

**LSP Features to Implement:**
1. **gopls Proxy Architecture**
   - Wrap gopls as subprocess
   - Forward LSP requests/responses
   - Translate positions using source maps

2. **Source Map Integration**
   - Read `.go.map` files (already generated by transpiler)
   - Bidirectional position mapping (.dingo ↔ .go)
   - Handle multi-line transformations

3. **Core IDE Features**
   - Autocomplete (completion)
   - Go to definition (textDocument/definition)
   - Hover information (textDocument/hover)
   - Diagnostics (textDocument/publishDiagnostics)
   - Document symbols (textDocument/documentSymbol)

4. **File Watching**
   - Monitor `.dingo` file changes
   - Trigger transpilation
   - Update gopls with generated `.go` files

### Explicitly Deferred (Phase V Iteration 2)

**NOT in this session:**
- Lambda LSP support (Phase 4 not done yet)
- Ternary operator LSP support (Phase 4 not done yet)
- Null coalescing LSP support (Phase 4 not done yet)
- Tuple LSP support (Phase 4 not done yet)

These will be added AFTER Phase 4 completes.

## Architecture Requirements

### Reference Architectures
- **templ** (github.com/a-h/templ): gopls proxy architecture reference
- **gopls** (golang.org/x/tools/gopls): Language server to wrap
- **TypeScript**: Source map integration patterns

### Technical Requirements

1. **Binary:** `cmd/dingo-lsp/main.go`
   - Speaks LSP protocol on stdin/stdout
   - Launches gopls as subprocess
   - Manages lifecycle

2. **Source Map Reader:** `pkg/sourcemap/reader.go`
   - Parse `.go.map` JSON files
   - Provide position translation functions
   - Handle edge cases (one-to-many mappings)

3. **LSP Proxy:** `pkg/lsp/proxy.go`
   - Forward non-.dingo requests directly to gopls
   - Translate .dingo requests using source maps
   - Translate gopls responses back to .dingo positions

4. **File Watcher:** `pkg/lsp/watcher.go`
   - Use fsnotify or similar
   - Trigger `dingo build` on .dingo file changes
   - Notify gopls of .go file updates

### Source Map Format (Already Exists)

The transpiler already generates `.go.map` files in this format:
```json
{
  "version": 1,
  "dingo_file": "example.dingo",
  "go_file": "example.go",
  "mappings": [
    {
      "dingo_line": 5,
      "dingo_col": 10,
      "go_line": 8,
      "go_col": 15,
      "length": 12
    }
  ]
}
```

The LSP needs to READ this format, not create it.

## Success Criteria

### Must Have
1. ✅ VSCode can open `.dingo` files and get IDE features
2. ✅ Autocomplete works for Dingo syntax
3. ✅ Go to definition works across .dingo files
4. ✅ Error diagnostics show in correct .dingo positions
5. ✅ Hover shows type information

### Nice to Have
1. Document symbols for navigation
2. Rename refactoring
3. Find references

### Quality Requirements
1. No crashes on malformed .dingo files
2. Performance: <100ms latency for autocomplete
3. Graceful degradation if gopls unavailable

## Deliverables

1. **Code:**
   - `cmd/dingo-lsp/main.go` - LSP server binary
   - `pkg/lsp/proxy.go` - gopls proxy
   - `pkg/sourcemap/reader.go` - Source map parser
   - `pkg/lsp/watcher.go` - File watcher

2. **Tests:**
   - Unit tests for source map translation
   - Integration tests with gopls
   - End-to-end tests with LSP client

3. **Documentation:**
   - VSCode extension configuration
   - How to debug LSP
   - Architecture diagram

4. **VSCode Extension (Minimal):**
   - Language ID: `dingo`
   - Grammar: Dingo syntax highlighting (reuse from existing work if available)
   - LSP client configuration

## Timeline Expectations

**Realistic:** 1-2 weeks for iteration 1
- Week 1: Architecture, gopls proxy, source map integration
- Week 2: File watching, VSCode extension, testing

## Notes

- This is the FOUNDATION for LSP support
- Focus on correctness over features
- Simple, clean architecture that can evolve
- Don't over-engineer: wrap gopls, translate positions, done
- Phase 4 features will be added in iteration 2 (separate session)

## Related Files

- Coordination: `/Users/jack/mag/dingo/ai-docs/sessions/phase4-5-coordination.md`
- Source maps: Generated by transpiler in `tests/golden/*.go.map`
- Current features: See `CLAUDE.md` Phase 3 complete section
