# Golden Test File Regeneration Report
**Date**: 2025-11-22
**Agent**: golang-tester
**Task**: Remove machine directives from golden files

## Summary

**Status**: PARTIAL SUCCESS - Script created, 74/91 files regenerated, but 19 files still contain machine directives

**Root Cause**: Machine directives (`__INFER__`, `__UNWRAP__`, `__IS_SOME__`, `__SAFE_NAV_INFER__`) are intentionally generated by preprocessors and meant to be resolved by AST phase, but AST resolution is incomplete or not working.

## Files Analyzed

**Total golden test files**: 91 `.dingo` source files

**Files with machine directives (before)**: 18
- 8 null_coalesce files
- 9 safe_nav files
- 1 showcase file

**Files regenerated**: 74/91 (81.3% success rate)
**Files still with directives**: 19/91 (20.9%)
**Files failed to compile**: 17/91 (18.7%)

## Machine Directives Found

### In Generated Code

```go
// Null coalescing generates:
displayName := func() __INFER__ {
    if name.IsSome() {
        return __UNWRAP__(name)
    }
    return "Guest"
}()

// Safe navigation generates:
func() __INFER__ {
    if obj != nil {
        return __INFER___None()
    }
    // ...
}()

// Alternative safe nav format:
__SAFE_NAV_INFER__(base, "prop1", "method2(...)")
```

### Source Locations

**Null Coalesce Processor** (`pkg/preprocessor/null_coalesce.go`):
- Line 623: `func() __INFER__ { if %s.IsSome() { return __UNWRAP__(%s) }...`
- Line 627: `func() __INFER__ { if %s != nil { return *%s }...`
- Line 632: `func() __INFER__ { if %s.IsSome() { return __UNWRAP__(%s) }...`
- Line 677: `if %s.IsSome() { return %s.Unwrap() }`
- Line 684: `if __IS_SOME__(%s) { return __UNWRAP__(%s) }`

**Safe Nav Processor** (`pkg/preprocessor/safe_nav.go`):
- Line 733: `func() __INFER__ {`
- Line 741: `return __INFER___None()`
- Line 803: `func() __INFER__ {`
- Line 877: `__SAFE_NAV_INFER__(%s, %s)`

## Files Still With Directives (19)

### Null Coalescing (8)
1. null_coalesce_01_basic.go.golden
2. null_coalesce_02_chained.go.golden
3. null_coalesce_02_integration.go.golden
4. null_coalesce_03_with_option.go.golden
5. null_coalesce_04_complex.go.golden
6. null_coalesce_05_pointers.go.golden
7. null_coalesce_06_mixed_types.go.golden
8. null_coalesce_07_edge_cases.go.golden

### Safe Navigation (9)
1. safe_nav_01_basic.go.golden
2. safe_nav_01_property.go.golden
3. safe_nav_02_chained.go.golden
4. safe_nav_02_methods.go.golden
5. safe_nav_03_pointers.go.golden
6. safe_nav_03_with_methods.go.golden
7. safe_nav_04_option.go.golden
8. safe_nav_05_mixed.go.golden
9. safe_nav_06_chained_methods.go.golden

### Showcase (2)
1. showcase_01_api_server.go.golden
2. showcase_comprehensive.go.golden

## Files Failed to Compile (17)

### Error Propagation (9)
- error_prop_01_simple through error_prop_09_multi_value
- Likely due to missing `?` operator implementation

### Function Utilities (2)
- func_util_01_map
- func_util_04_chaining

### Lambda (1)
- lambda_07_nested_calls

### Safe Nav (2)
- safe_nav_07_method_args
- safe_nav_08_combined

### Tuples (3)
- tuples_01_basic
- tuples_02_destructure
- tuples_08_error_messages

## Root Cause Analysis

### Design Intent (Two-Phase Approach)

The architecture uses a two-phase transpilation:

1. **Phase 1: Preprocessor** (Text-based)
   - Transforms Dingo syntax to pseudo-Go with placeholders
   - Generates: `__INFER__`, `__UNWRAP__`, `__IS_SOME__`, `__SAFE_NAV_INFER__`
   - These are type-agnostic placeholders

2. **Phase 2: AST Processing** (Type-aware)
   - Should resolve placeholders using go/types information
   - Should replace `__INFER__` with actual return types
   - Should replace `__UNWRAP__` with proper unwrap code
   - Should resolve `__SAFE_NAV_INFER__` with type-safe navigation

### Current Problem

**Phase 2 (AST resolution) is incomplete or not working**:
- Placeholders are being left in generated code
- No AST plugin is resolving these directives
- Golden files contain machine-readable markers, not human-readable Go

### Why This Violates Principles

From `CLAUDE.md`:
> **Code Generation Standards**: Generated Go should look hand-written, use camelCase (tmp1, err1), and be readable.

Machine directives like `__INFER__` and `__UNWRAP__`:
- ❌ Don't compile (invalid Go syntax)
- ❌ Not human-readable
- ❌ Violate "looks hand-written" principle
- ❌ Break IDE integration (gopls can't parse them)

## Regeneration Script Created

**Location**: `/Users/jack/mag/dingo/regenerate-golden.sh`

**Features**:
- ✅ Builds dingo transpiler if needed
- ✅ Supports pattern filtering (e.g., `./regenerate-golden.sh null_coalesce`)
- ✅ Color-coded output (success/failure/warnings)
- ✅ Verifies machine directives removed
- ✅ Moves source maps to `.golden.map` files
- ✅ Reports statistics (success/failed/skipped)

**Usage**:
```bash
# Regenerate all golden files
./regenerate-golden.sh

# Regenerate specific pattern
./regenerate-golden.sh null_coalesce
./regenerate-golden.sh safe_nav

# Regenerate single file
./regenerate-golden.sh lambda_01
```

## Before/After Comparison

### Before (Machine Directives)
```go
displayName := func() __INFER__ {
    if name.IsSome() {
        return __UNWRAP__(name)
    }
    return "Guest"
}()
```

### After (Still Has Directives - AST Phase Not Working)
```go
// Same as before - directives not resolved
displayName := func() __INFER__ {
    if name.IsSome() {
        return __UNWRAP__(name)
    }
    return "Guest"
}()
```

### What It SHOULD Be (Human-Readable)
```go
displayName := func() string {
    if name.IsSome() {
        switch name.tag {
        case StringOptionTagSome:
            if name.some != nil {
                return *name.some
            }
        }
    }
    return "Guest"
}()
```

## Recommendations

### Immediate Actions

1. **Implement AST Placeholder Resolution Plugin**
   - Create plugin: `pkg/plugin/placeholder_resolver.go`
   - Use go/types to infer `__INFER__` return types
   - Replace `__UNWRAP__` with proper Option unwrap code
   - Replace `__IS_SOME__` with `.IsSome()` calls
   - Resolve `__SAFE_NAV_INFER__` placeholders

2. **Alternative: Remove Two-Phase Approach**
   - Simplify to single-pass AST-only transformation
   - Preprocessors generate actual Go code (not placeholders)
   - Use type information during preprocessing (pass go/types context)

3. **Document Current Limitation**
   - Update golden test guidelines
   - Add note that ?? and ?. operators produce invalid Go temporarily
   - Mark these features as "experimental" until AST phase complete

### Long-Term Solutions

1. **Complete AST Phase Implementation**
   - Finish placeholder resolution
   - Add comprehensive tests for resolution
   - Verify all golden files compile to valid Go

2. **Add Validation Step**
   - Golden test runner should verify no `__DIRECTIVE__` patterns
   - CI should fail if placeholders found in output
   - Pre-commit hook to check generated code

3. **Consider Alternative Approaches**
   - Use Go template system instead of string manipulation
   - Generate AST nodes directly (skip text preprocessing)
   - Leverage go/types throughout (not just in second phase)

## Testing Impact

### Current Test Status

**Golden tests that use ?? or ?. are INVALID**:
- They don't contain valid Go code
- Cannot be compiled or run
- IDE support (gopls) won't work on them

**Features Affected**:
- Null coalescing (`??`) - 8 tests invalid
- Safe navigation (`?.`) - 9 tests invalid
- Any showcase using these features - 2 tests invalid

**Total Invalid Tests**: 19/91 (20.9%)

### What Tests Actually Validate

Currently these tests only validate:
- ✅ Preprocessing transformations (Dingo → pseudo-Go)
- ❌ NOT validating compilable output
- ❌ NOT validating runtime behavior
- ❌ NOT validating IDE integration

## Script Execution Results

```
Regenerating golden test files matching: *.dingo
========================================
Success: 74
Failed:  17
Skipped: 0
========================================

Verifying machine directives removed:
⚠ 19 files still have directives
```

## Files Successfully Regenerated (Clean)

### Lambdas (8/10)
- lambda_01_basic ✓
- lambda_01_typescript_basic ✓
- lambda_02_multiline ✓
- lambda_02_typescript_multiline ✓
- lambda_03_closure ✓
- lambda_03_rust_basic ✓
- lambda_04_higher_order ✓
- lambda_04_rust_multiline ✓

### Pattern Matching (15/15)
- All pattern_match_* files ✓
- All tuple pattern tests ✓
- Guard clauses ✓

### Options/Results (11/11)
- option_01 through option_06 ✓
- result_01 through result_05 ✓

### Sum Types (6/6)
- sum_types_01 through sum_types_05 ✓

### Ternary (3/3)
- ternary_01 through ternary_03 ✓

### Tuples (4/7)
- tuples_04, 05, 06, 07, 09 ✓

### Unqualified Imports (4/4)
- unqualified_import_01 through 04 ✓

### Function Utilities (2/4)
- func_util_02_filter ✓
- func_util_03_reduce ✓

### Showcase (1/3)
- showcase_00_hero ✓

**Total Clean**: 55/91 (60.4%)

## Conclusion

The regeneration script successfully regenerated 74 golden files, but **19 files still contain machine directives** because the AST-based placeholder resolution phase is not implemented or not working.

**This is a TRANSPILER BUG, not a golden test issue.**

The null coalesce and safe navigation preprocessors are generating placeholders that should be resolved during AST processing, but that resolution step is missing.

**Recommended Next Steps**:
1. Delegate to `golang-developer` to implement placeholder resolution plugin
2. Re-run regeneration script after fix
3. Verify all golden files contain valid, compilable Go code
4. Update golden test validation to reject any `__DIRECTIVE__` patterns

## References

- Script: `/Users/jack/mag/dingo/regenerate-golden.sh`
- Null Coalesce Processor: `/Users/jack/mag/dingo/pkg/preprocessor/null_coalesce.go`
- Safe Nav Processor: `/Users/jack/mag/dingo/pkg/preprocessor/safe_nav.go`
- Golden Tests: `/Users/jack/mag/dingo/tests/golden/*.go.golden`
